#!/usr/bin/env node

var path = require('path')
var spawn = require('child_process').spawn
var which = require('which')

which('electron', function (err, resolvedPath) {
  if (!resolvedPath) return runElectron(process.env.ELECTRON_PATH)
  if (resolvedPath) return runElectron(resolvedPath)
  if (err) console.error(err)
})

function runElectron (resolvedPath) {
  // Default exit code
  var exitCode = 0;

  var args = process.argv.slice(2)
  args.unshift(path.resolve(path.join(__dirname, '../index.js')))
  var electron = spawn(resolvedPath, args, { stdio: ['inherit', 'inherit', 'pipe'] })
  electron.stderr.on('data', function (data) {
    var str = data.toString('utf8')
    // it's Chromium, STFU
    if (str.match(/^\[\d+\:\d+/)) return

    // Parse for EXITCODE
    if (str.indexOf('EXITCODE:') === 0) {
      // memorize for "later"
      exitCode = parseInt(str.substr(9), 10)
      return;
    }
    process.stderr.write(data)
  })

  // If electron has exited
  electron.on('exit', function(){
    // we exit with the correct code
    process.exit(exitCode)
  });
}
